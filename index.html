<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sylvie's Bedtime Stories</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>
  <!-- Boxicons CSS for icons -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-6">
  <div class="container mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Sylvie's Bedtime Stories</h1>
        <button id="themeToggle" class="bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-3 py-1 rounded">
            Toggle Theme
          </button>
    </div>
    <!-- Header: Feed Meta Information -->
    <header class="mb-6">
        <div class="flex gap-8 justify-between">
          <!-- Feed Image (if available) -->
            <div class="flex flex-col items-center gap-4">
                <div id="feedImageContainer" class="min-w-64"></div>
            </div>
          
          <div>
            <h1 id="feedTitle" class="text-3xl font-bold"></h1>
            <p id="feedDesc" class="mt-1"></p>
            <div id="feedMeta" class="mt-2 text-sm">
              <span id="feedAuthor"></span>
              <span id="feedCopyright" class="ml-2"></span>
            </div>
            <div id="feedLinkContainer" class="mt-2">
              <a id="feedLink" href="#" target="_blank" class="text-blue-500 underline"></a>
            </div>
          </div>
        </div>
      </header>

    
    

    

    

    <!-- Playlist -->
    <div id="playlist" class="bg-white dark:bg-gray-800 rounded shadow p-4 mb-36">
      <h2 class="text-xl font-semibold mb-2">Playlist</h2>
      <ul id="trackList" class="space-y-2"></ul>
    </div>
  </div>

  <!-- Sticky Play Bar -->
  <div class="fixed bottom-0 left-0 w-full z-50 backdrop-blur-sm bg-white/70 dark:bg-gray-900/70 shadow-lg px-4 py-2 flex flex-col items-center justify-between gap-4">
    <div class="flex flex-col items-center gap-4 w-80">
      <!-- <div id="nowPlaying" class="text-sm w-full px-2"><span id="nowPlayingTitle">None</span></div> -->
      <div class="flex items-center gap-4 w-full md:w-auto">
        <!-- <div id="feedImageContainer" class="hidden md:block w-12 h-12"></div> -->
        <div class="flex items-center space-x-4 w-full">
          <button id="prevButton" class="flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded">
            <i class="bx bx-skip-previous text-2xl"></i>
          </button>
          <button id="playPauseButton" class="flex items-center justify-center bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded">
            <i id="playPauseIcon" class="bx bx-play text-2xl"></i>
          </button>
          <button id="loopButton" class="flex items-center justify-center bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded">
            <i class="bx bx-repeat text-2xl"></i>
          </button>
          <button id="nextButton" class="flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded">
            <i class="bx bx-skip-next text-2xl"></i>
          </button>
          <button id="downloadButton" class="flex items-center justify-center bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded">
            <i class="bx bx-download text-2xl"></i>
          </button>
        </div>
      </div>
      <div class="flex items-center w-full md:w-auto pb-2">
        <audio id="audioPlayer" src="" style="display:none"></audio>
        <div id="audio-wrapper" class="flex items-center w-full relative">
          <div class="relative w-72 h-2 bg-black/50 rounded overflow-hidden">
            <input id="seek" type="range" min="0" max="100" value="0" class="absolute p-0 z-50 top-0 left-0 w-full h-2 opacity-0 cursor-pointer" />
            <div id="bufferBar" class="absolute top-0 left-0 h-2 bg-gray-400/50" style="width:0%"></div>
            <div id="progressBar" class="absolute top-0 left-0 h-2 bg-purple-500" style="width:0%">
              <div id="playhead" class="absolute top-0 w-3 h-2 bg-white rounded-full" style="left:0%"></div>
            </div>
          </div>
          <!-- <button id="playPause" class="px-2 py-1 bg-blue-500 text-white rounded">Play</button> -->
          <div class="absolute right-0 bottom-2 h-2">
            <div class="absolute left-0 pl-2 text-sm w-32">
              <span id="current">0:00</span> / <span id="duration">0:00</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Theme toggle functionality
    document.getElementById('themeToggle').addEventListener('click', function() {
      document.documentElement.classList.toggle('dark');
    });

    let loopEnabled = true; // Loop is toggled on by default
    let currentTrack = 0;
    let playlist = [];

    async function fetchData() {
      try {
        const response = await fetch('/api/little-stories');
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return await response.json();
      } catch (error) {
        console.error("Error fetching data:", error);
        return null;
      }
    }

    async function initPlayer() {
      const data = await fetchData();
      if (!data) return;
      
      // Display feed meta information
      const meta = data.meta;
      document.getElementById('feedTitle').textContent = meta.title;
      document.getElementById('feedDesc').textContent = meta.description;
      document.getElementById('feedAuthor').textContent = meta['itunes:author'] || meta['itunesOwner']?.['itunes:name'] || "";
      document.getElementById('feedCopyright').textContent = meta.copyright || "";
      const feedLink = document.getElementById('feedLink');
      feedLink.textContent = meta.link;
      feedLink.href = meta.link;
      
      if (meta.itunesImage) {
        document.getElementById('feedImageContainer').innerHTML = `<img src="${meta.itunesImage}" alt="Feed Image" class="w-full max-w-md mx-auto rounded shadow">`;
      }

      // Set up playlist
      playlist = data.playlist;
      if (playlist.length === 0) {
        document.getElementById('trackList').innerHTML = "<li>No episodes available</li>";
        return;
      }
      const audioPlayer = document.getElementById('audioPlayer');
      const trackList = document.getElementById('trackList');

      // Populate the playlist UI
      playlist.forEach((track, index) => {
        const li = document.createElement('li');
        li.textContent = track.title;
        li.className = "cursor-pointer p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded";
        li.onclick = () => {
          currentTrack = index;
          loadTrack(currentTrack);
        };
        trackList.appendChild(li);
      });

      function highlightTrack(index) {
        const items = trackList.getElementsByTagName('li');
        for (let i = 0; i < items.length; i++) {
          if (i === index) {
            items[i].classList.add("bg-gray-300", "dark:bg-gray-600");
          } else {
            items[i].classList.remove("bg-gray-300", "dark:bg-gray-600");
          }
        }
      }

      function loadTrack(index) {
        if (index >= playlist.length || index < 0) return;
        audioPlayer.src = playlist[index].url;
        highlightTrack(index);
        audioPlayer.play();
      }

      // Previous button functionality
      document.getElementById('prevButton').addEventListener('click', () => {
        if (currentTrack > 0) {
          currentTrack--;
        } else if (loopEnabled) {
          currentTrack = playlist.length - 1;
        }
        loadTrack(currentTrack);
      });

      // Next button functionality
      document.getElementById('nextButton').addEventListener('click', () => {
        if (currentTrack < playlist.length - 1) {
          currentTrack++;
        } else if (loopEnabled) {
          currentTrack = 0;
        }
        loadTrack(currentTrack);
      });

      // Loop toggle button functionality
      document.getElementById('loopButton').addEventListener('click', () => {
        loopEnabled = !loopEnabled;
        const loopButton = document.getElementById('loopButton');
        // set the class on the button based on the loopEnabled state
        loopButton.classList.toggle('bg-green-500', loopEnabled);
        loopButton.classList.toggle('bg-gray-500', !loopEnabled);
      });

      // Play/Pause button functionality
      const playPauseButton = document.getElementById('playPauseButton');
      const playPauseIcon = document.getElementById('playPauseIcon');
      function updatePlayPauseIcon() {
        if (audioPlayer.paused) {
          playPauseIcon.classList.remove('bx-pause');
          playPauseIcon.classList.add('bx-play');
        } else {
          playPauseIcon.classList.remove('bx-play');
          playPauseIcon.classList.add('bx-pause');
        }
      }
      playPauseButton.addEventListener('click', () => {
        if (audioPlayer.paused) {
          audioPlayer.play();
        } else {
          audioPlayer.pause();
        }
        updatePlayPauseIcon();
      });
      audioPlayer.addEventListener('play', updatePlayPauseIcon);
      audioPlayer.addEventListener('pause', updatePlayPauseIcon);

      // Auto-advance when a track ends
      audioPlayer.addEventListener('ended', () => {
        if (isQuietHours()) return;
        if (currentTrack < playlist.length - 1) {
          currentTrack++;
        } else if (loopEnabled) {
          currentTrack = 0;
        }
        loadTrack(currentTrack);
      });

      // Load the first track
      loadTrack(currentTrack);
    }

    // Initialize the media player on page load
    initPlayer();

    const audio = document.getElementById('audioPlayer');
    // const playPause = document.getElementById('playPause');
    const seek = document.getElementById('seek');
    const current = document.getElementById('current');
    const duration = document.getElementById('duration');
    const bufferBar = document.getElementById('bufferBar');
    const progressBar = document.getElementById('progressBar');

    function formatTime(s) {
      const m = Math.floor(s / 60);
      const sec = Math.floor(s % 60).toString().padStart(2, '0');
      return `${m}:${sec}`;
    }

    function updateBuffer() {
      if (audio.buffered.length) {
        const bufferedEnd = audio.buffered.end(audio.buffered.length - 1);
        const percent = (bufferedEnd / (audio.duration || 1)) * 100;
        bufferBar.style.width = percent + '%';
      } else {
        bufferBar.style.width = '0%';
      }
    }

    // isQuietHours checks if current time is between 7:15 AM and 8:00 AM
    function isQuietHours() {
      const now = new Date();
      if ((now.getHours() === 7 || now.getHours() === 10) && now.getMinutes() >= 15) {
        audio.pause();
        loopEnabled = false;
        updatePlayPauseIcon();
      }
      return ((now.getHours() === 7 || now.getHours() === 10) && now.getMinutes() >= 15);
    }

    function updateProgressBar() {
      const percent = (audio.currentTime / (audio.duration || 1)) * 100;
      progressBar.style.width = percent + '%';
      // Move playhead so its center matches the progress
      const playhead = document.getElementById('playhead');
      const bar = progressBar.parentElement;
      const barWidth = bar.offsetWidth;
      const playheadWidth = playhead.offsetWidth;
      // Calculate left so center of playhead matches progress
      const left = (barWidth * percent / 100) - (playheadWidth / 2);
      playhead.style.left = `${Math.max(0, Math.min(left, barWidth - playheadWidth))}px`;
    }

    audio.addEventListener('progress', updateBuffer);
    audio.addEventListener('timeupdate', () => {
      updateProgressBar();
      current.textContent = formatTime(audio.currentTime);
    });
    audio.addEventListener('loadedmetadata', () => {
      duration.textContent = formatTime(audio.duration);
      updateBuffer();
      updateProgressBar();
    });

    seek.addEventListener('input', e => {
      audio.currentTime = (e.target.value / 100) * audio.duration;
      updateProgressBar();
    });

    // playPause.addEventListener('click', () => {
    //   if (audio.paused) {
    //     audio.play();
    //     playPause.textContent = 'Pause';
    //   } else {
    //     audio.pause();
    //     playPause.textContent = 'Play';
    //   }
    // });

    audio.addEventListener('play', () => playPause.textContent = 'Pause');
    audio.addEventListener('pause', () => playPause.textContent = 'Play');

    // // // Download button functionality
    // document.getElementById('downloadButton').addEventListener('click', async () => {
    //   if (!audio.src) return;
    //   try {
    //     const response = await fetch(audio.src);
    //     const blob = await response.blob();
    //     const url = URL.createObjectURL(blob);
    //     const a = document.createElement('a');
    //     a.href = url;
    //     a.download = audio.src.split('/').pop(); // Use filename from URL
    //     document.body.appendChild(a);
    //     a.click();
    //     document.body.removeChild(a);
    //     URL.revokeObjectURL(url);
    //   } catch (err) {
    //     alert('Download failed.');
    //   }
    // });

    // Download button functionality
    document.getElementById('downloadButton').addEventListener('click', () => {
      if (!audio.src) return;
      const a = document.createElement('a');
      a.href = audio.src;
      a.download = audio.src.split('/').pop(); // Use filename from URL
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
  </script>
</body>
</html>
